# ============================================
# Cashflow - Docker Compose Override
# ============================================
# Configura√ß√µes adicionais para desenvolvimento
# Este arquivo √© automaticamente carregado junto
# com o docker-compose.yml
# ============================================

services:
  # ==========================================
  # üåê API - Cashflow Web API
  # ==========================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
      # Usa o stage 'final' que tem o ENTRYPOINT configurado
    container_name: cashflow-api
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=${POSTGRES_DB:-cashflow_db};Username=${POSTGRES_USER:-cashflow};Password=${POSTGRES_PASSWORD:-cashflow123}
      - ConnectionStrings__Redis=redis:6379
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Port=5672
      - RabbitMQ__Username=${RABBITMQ_USER:-cashflow}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-cashflow123}
      - RabbitMQ__VirtualHost=${RABBITMQ_VHOST:-cashflow}
    ports:
      - "${API_PORT:-5000}:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - cashflow-network
    profiles:
      - app

  # ==========================================
  # ‚öôÔ∏è Worker - Consolidation Worker
  # ==========================================
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
      # Usa o stage 'final' que tem o ENTRYPOINT configurado
    container_name: cashflow-worker
    restart: unless-stopped
    environment:
      - DOTNET_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=${POSTGRES_DB:-cashflow_db};Username=${POSTGRES_USER:-cashflow};Password=${POSTGRES_PASSWORD:-cashflow123}
      - ConnectionStrings__Redis=redis:6379
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Port=5672
      - RabbitMQ__Username=${RABBITMQ_USER:-cashflow}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-cashflow123}
      - RabbitMQ__VirtualHost=${RABBITMQ_VHOST:-cashflow}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - cashflow-network
    profiles:
      - app

  # ==========================================
  # üß™ Testes - Execu√ß√£o de Testes
  # ==========================================
  tests:
    build:
      context: .
      dockerfile: Dockerfile
      target: build
    container_name: cashflow-tests
    working_dir: /src
    command: dotnet test --verbosity normal --results-directory /src/test-results
    volumes:
      - .:/src
      - ~/.nuget/packages:/root/.nuget/packages:ro
    networks:
      - cashflow-network
    profiles:
      - test



