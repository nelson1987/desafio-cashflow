# ============================================
# Cashflow - CI/CD Pipeline
# ============================================
# Pipeline completo com:
# - Build e Restore
# - FormataÃ§Ã£o de cÃ³digo
# - Testes unitÃ¡rios
# - Testes de integraÃ§Ã£o com Testcontainers
# - AnÃ¡lise de cÃ³digo
# - Build de imagens Docker
# ============================================

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]

env:
  DOTNET_VERSION: "9.0.x"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

# PermissÃµes necessÃ¡rias para o GITHUB_TOKEN
permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  # ==========================================
  # ğŸ”¨ Build e Restore
  # ==========================================
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ Cache de pacotes NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: ğŸ“¥ Restore de dependÃªncias
        run: dotnet restore Cashflow.sln

      - name: ğŸ—ï¸ Build da soluÃ§Ã£o
        run: dotnet build Cashflow.sln --configuration Release --no-restore

      - name: ğŸ“¤ Upload de artefatos
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            **/bin/Release/
            !**/obj/
          retention-days: 1

  # ==========================================
  # ğŸ“ FormataÃ§Ã£o e AnÃ¡lise de CÃ³digo
  # ==========================================
  format:
    name: Format & Lint
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¥ Restore de dependÃªncias
        run: dotnet restore Cashflow.sln

      - name: ğŸ¨ Verificar formataÃ§Ã£o de cÃ³digo
        run: dotnet format Cashflow.sln --verify-no-changes --verbosity diagnostic
        continue-on-error: true

      - name: ğŸ“Š AnÃ¡lise de cÃ³digo com dotnet analyze
        run: dotnet build Cashflow.sln --configuration Release /p:TreatWarningsAsErrors=false
        continue-on-error: true

  # ==========================================
  # ğŸ§ª Testes UnitÃ¡rios
  # ==========================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ Cache de pacotes NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: ğŸ“¥ Restore de dependÃªncias
        run: dotnet restore Cashflow.sln

      - name: ğŸ§ª Executar testes unitÃ¡rios
        run: |
          dotnet test tests/Cashflow.Tests/Cashflow.Tests.csproj \
            --configuration Release \
            --no-restore \
            --logger "trx;LogFileName=unit-tests.trx" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults

      - name: ğŸ“Š Upload de resultados de testes
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: ./TestResults
          retention-days: 7

      - name: ğŸ“ˆ Publicar relatÃ³rio de testes
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Unit Tests Report
          path: ./TestResults/*.trx
          reporter: dotnet-trx
          fail-on-error: true

  # ==========================================
  # ğŸ”Œ Testes de IntegraÃ§Ã£o
  # ==========================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build

    services:
      docker:
        image: docker:dind
        options: --privileged

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ Cache de pacotes NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: ğŸ“¥ Restore de dependÃªncias
        run: dotnet restore Cashflow.sln

      - name: ğŸ³ Setup Docker para Testcontainers
        run: |
          docker --version
          docker info

      - name: ğŸ”Œ Executar testes de integraÃ§Ã£o
        run: |
          dotnet test tests/Cashflow.IntegrationTests/Cashflow.IntegrationTests.csproj \
            --configuration Release \
            --no-restore \
            --logger "trx;LogFileName=integration-tests.trx" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults
        env:
          TESTCONTAINERS_RYUK_DISABLED: false
          DOCKER_HOST: unix:///var/run/docker.sock

      - name: ğŸ“Š Upload de resultados de testes
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: ./TestResults
          retention-days: 7

      - name: ğŸ“ˆ Publicar relatÃ³rio de testes
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Integration Tests Report
          path: ./TestResults/*.trx
          reporter: dotnet-trx
          fail-on-error: true

  # ==========================================
  # ğŸš€ Testes de Performance (K6)
  # ==========================================
  performance-tests:
    name: Performance Tests (K6)
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: cashflow
          POSTGRES_PASSWORD: cashflow123
          POSTGRES_DB: cashflow_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      rabbitmq:
        image: rabbitmq:3-management-alpine
        env:
          RABBITMQ_DEFAULT_USER: cashflow
          RABBITMQ_DEFAULT_PASS: cashflow123
          RABBITMQ_DEFAULT_VHOST: cashflow
        ports:
          - 5672:5672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¥ Restore e Build
        run: |
          dotnet restore Cashflow.sln
          dotnet build src/Cashflow.WebApi --configuration Release --no-restore

      - name: ğŸš€ Iniciar API em background
        run: |
          cd src/Cashflow.WebApi
          nohup dotnet run --configuration Release --no-build > /tmp/api.log 2>&1 &
          echo $! > /tmp/api.pid
        env:
          ASPNETCORE_URLS: http://localhost:5000
          ConnectionStrings__PostgreSQL: "Host=localhost;Port=5432;Database=cashflow_db;Username=cashflow;Password=cashflow123"
          ConnectionStrings__Redis: "localhost:6379"
          RabbitMQ__Host: localhost
          RabbitMQ__Port: 5672
          RabbitMQ__Username: cashflow
          RabbitMQ__Password: cashflow123
          RabbitMQ__VirtualHost: cashflow

      - name: â³ Aguardar API ficar pronta
        run: |
          echo "Aguardando API iniciar..."
          for i in {1..30}; do
            if curl -s http://localhost:5000/health > /dev/null 2>&1; then
              echo "âœ… API estÃ¡ pronta!"
              exit 0
            fi
            echo "Tentativa $i/30..."
            sleep 2
          done
          echo "âŒ API nÃ£o iniciou a tempo"
          cat /tmp/api.log
          exit 1

      - name: ğŸ”§ Setup K6
        uses: grafana/setup-k6-action@v1

      - name: ğŸ”¥ Smoke Test
        run: k6 run tests/k6/smoke-test.js
        env:
          BASE_URL: http://localhost:5000

      - name: ğŸ“Š Load Test - Consolidado (55 RPS)
        run: k6 run tests/k6/consolidado-load-test.js --out json=k6-results.json
        env:
          BASE_URL: http://localhost:5000
        continue-on-error: true

      - name: ğŸ“ˆ Upload K6 Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-performance-results
          path: k6-results.json
          retention-days: 30

      - name: ğŸ›‘ Parar API
        if: always()
        run: |
          if [ -f /tmp/api.pid ]; then
            kill $(cat /tmp/api.pid) || true
          fi

  # ==========================================
  # ğŸ³ Build de Imagens Docker
  # ==========================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Login no Docker Hub
        uses: docker/login-action@v3
        if: github.event_name == 'push'
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        continue-on-error: true

      - name: ğŸ·ï¸ Extrair metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            cashflow/api
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build da imagem Docker (API)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: cashflow/api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ³ Build da imagem Docker (Worker)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.worker
          push: false
          tags: cashflow/worker:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================
  # ğŸ“Š Cobertura de CÃ³digo
  # ==========================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download de resultados de testes unitÃ¡rios
        uses: actions/download-artifact@v4
        with:
          name: unit-test-results
          path: ./TestResults/unit

      - name: ğŸ“¥ Download de resultados de testes de integraÃ§Ã£o
        uses: actions/download-artifact@v4
        with:
          name: integration-test-results
          path: ./TestResults/integration
        continue-on-error: true

      - name: ğŸ“Š Upload para Codecov
        uses: codecov/codecov-action@v4
        with:
          directory: ./TestResults
          fail_ci_if_error: false
          verbose: true
        continue-on-error: true

  # ==========================================
  # âœ… Status Final
  # ==========================================
  status-check:
    name: Status Check
    runs-on: ubuntu-latest
    needs: [build, format, unit-tests, integration-tests]
    if: always()

    steps:
      - name: âœ… Verificar status dos jobs
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "âŒ Build falhou"
            exit 1
          fi
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "âŒ Testes unitÃ¡rios falharam"
            exit 1
          fi
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "âŒ Testes de integraÃ§Ã£o falharam"
            exit 1
          fi
          echo "âœ… Todos os jobs passaram com sucesso!"

