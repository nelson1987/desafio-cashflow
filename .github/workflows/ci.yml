# ============================================
# Cashflow - CI/CD Pipeline
# ============================================
# Pipeline completo com:
# - Build e Restore
# - FormataÃ§Ã£o de cÃ³digo
# - Testes unitÃ¡rios
# - Testes de integraÃ§Ã£o com Testcontainers
# - AnÃ¡lise de cÃ³digo
# - Build de imagens Docker
# ============================================

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]

env:
  DOTNET_VERSION: "9.0.x"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  # ==========================================
  # ğŸ”¨ Build e Restore
  # ==========================================
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ Cache de pacotes NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: ğŸ“¥ Restore de dependÃªncias
        run: dotnet restore Cashflow.sln

      - name: ğŸ—ï¸ Build da soluÃ§Ã£o
        run: dotnet build Cashflow.sln --configuration Release --no-restore

      - name: ğŸ“¤ Upload de artefatos
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            **/bin/Release/
            !**/obj/
          retention-days: 1

  # ==========================================
  # ğŸ“ FormataÃ§Ã£o e AnÃ¡lise de CÃ³digo
  # ==========================================
  format:
    name: Format & Lint
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¥ Restore de dependÃªncias
        run: dotnet restore Cashflow.sln

      - name: ğŸ¨ Verificar formataÃ§Ã£o de cÃ³digo
        run: dotnet format Cashflow.sln --verify-no-changes --verbosity diagnostic
        continue-on-error: true

      - name: ğŸ“Š AnÃ¡lise de cÃ³digo com dotnet analyze
        run: dotnet build Cashflow.sln --configuration Release /p:TreatWarningsAsErrors=false
        continue-on-error: true

  # ==========================================
  # ğŸ§ª Testes UnitÃ¡rios
  # ==========================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ Cache de pacotes NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: ğŸ“¥ Restore de dependÃªncias
        run: dotnet restore Cashflow.sln

      - name: ğŸ§ª Executar testes unitÃ¡rios
        run: |
          dotnet test tests/Cashflow.Tests/Cashflow.Tests.csproj \
            --configuration Release \
            --no-restore \
            --logger "trx;LogFileName=unit-tests.trx" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults

      - name: ğŸ“Š Upload de resultados de testes
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: ./TestResults
          retention-days: 7

      - name: ğŸ“ˆ Publicar relatÃ³rio de testes
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Unit Tests Report
          path: ./TestResults/*.trx
          reporter: dotnet-trx
          fail-on-error: true

  # ==========================================
  # ğŸ”Œ Testes de IntegraÃ§Ã£o
  # ==========================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build

    services:
      docker:
        image: docker:dind
        options: --privileged

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ Cache de pacotes NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: ğŸ“¥ Restore de dependÃªncias
        run: dotnet restore Cashflow.sln

      - name: ğŸ³ Setup Docker para Testcontainers
        run: |
          docker --version
          docker info

      - name: ğŸ”Œ Executar testes de integraÃ§Ã£o
        run: |
          dotnet test tests/Cashflow.IntegrationTests/Cashflow.IntegrationTests.csproj \
            --configuration Release \
            --no-restore \
            --logger "trx;LogFileName=integration-tests.trx" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults
        env:
          TESTCONTAINERS_RYUK_DISABLED: false
          DOCKER_HOST: unix:///var/run/docker.sock

      - name: ğŸ“Š Upload de resultados de testes
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: ./TestResults
          retention-days: 7

      - name: ğŸ“ˆ Publicar relatÃ³rio de testes
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Integration Tests Report
          path: ./TestResults/*.trx
          reporter: dotnet-trx
          fail-on-error: true

  # ==========================================
  # ğŸ³ Build de Imagens Docker
  # ==========================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Login no Docker Hub
        uses: docker/login-action@v3
        if: github.event_name == 'push'
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        continue-on-error: true

      - name: ğŸ·ï¸ Extrair metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            cashflow/api
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ³ Build da imagem Docker (API)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: cashflow/api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ³ Build da imagem Docker (Worker)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.worker
          push: false
          tags: cashflow/worker:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================
  # ğŸ“Š Cobertura de CÃ³digo
  # ==========================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download de resultados de testes unitÃ¡rios
        uses: actions/download-artifact@v4
        with:
          name: unit-test-results
          path: ./TestResults/unit

      - name: ğŸ“¥ Download de resultados de testes de integraÃ§Ã£o
        uses: actions/download-artifact@v4
        with:
          name: integration-test-results
          path: ./TestResults/integration
        continue-on-error: true

      - name: ğŸ“Š Upload para Codecov
        uses: codecov/codecov-action@v4
        with:
          directory: ./TestResults
          fail_ci_if_error: false
          verbose: true
        continue-on-error: true

  # ==========================================
  # âœ… Status Final
  # ==========================================
  status-check:
    name: Status Check
    runs-on: ubuntu-latest
    needs: [build, format, unit-tests, integration-tests]
    if: always()

    steps:
      - name: âœ… Verificar status dos jobs
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "âŒ Build falhou"
            exit 1
          fi
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "âŒ Testes unitÃ¡rios falharam"
            exit 1
          fi
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "âŒ Testes de integraÃ§Ã£o falharam"
            exit 1
          fi
          echo "âœ… Todos os jobs passaram com sucesso!"

