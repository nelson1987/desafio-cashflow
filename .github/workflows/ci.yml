# ============================================
# Cashflow - CI/CD Pipeline
# ============================================
# Pipeline completo com:
# - Build e Restore
# - Formata√ß√£o de c√≥digo
# - Testes unit√°rios
# - Testes de integra√ß√£o com Testcontainers
# - An√°lise de c√≥digo
# - Build de imagens Docker
# ============================================

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]

env:
  DOTNET_VERSION: "9.0.x"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

# Permiss√µes necess√°rias para o GITHUB_TOKEN
permissions:
  contents: write
  checks: write
  pull-requests: write
  packages: write

jobs:
  # ==========================================
  # üî® Build e Restore
  # ==========================================
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: üîß Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: üì¶ Cache de pacotes NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: üì• Restore de depend√™ncias
        run: dotnet restore Cashflow.sln

      - name: üèóÔ∏è Build da solu√ß√£o
        run: dotnet build Cashflow.sln --configuration Release --no-restore

      - name: üì§ Upload de artefatos
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            **/bin/Release/
            !**/obj/
          retention-days: 1

  # ==========================================
  # üìù Formata√ß√£o e An√°lise de C√≥digo
  # ==========================================
  format:
    name: Format & Lint
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: üîß Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: üì• Restore de depend√™ncias
        run: dotnet restore Cashflow.sln

      - name: üé® Verificar formata√ß√£o de c√≥digo
        run: dotnet format Cashflow.sln --verify-no-changes --verbosity diagnostic
        continue-on-error: true

      - name: üìä An√°lise de c√≥digo com dotnet analyze
        run: dotnet build Cashflow.sln --configuration Release /p:TreatWarningsAsErrors=false
        continue-on-error: true

  # ==========================================
  # üß™ Testes Unit√°rios
  # ==========================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: üîß Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: üì¶ Cache de pacotes NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: üì• Restore de depend√™ncias
        run: dotnet restore Cashflow.sln

      - name: üß™ Executar testes unit√°rios
        run: |
          dotnet test tests/Cashflow.Tests/Cashflow.Tests.csproj \
            --configuration Release \
            --no-restore \
            --logger "trx;LogFileName=unit-tests.trx" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults

      - name: üìä Upload de resultados de testes
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: ./TestResults
          retention-days: 7

      - name: üìà Publicar relat√≥rio de testes
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Unit Tests Report
          path: ./TestResults/*.trx
          reporter: dotnet-trx
          fail-on-error: true

  # ==========================================
  # üîå Testes de Integra√ß√£o
  # ==========================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build

    services:
      docker:
        image: docker:dind
        options: --privileged

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: üîß Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: üì¶ Cache de pacotes NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: üì• Restore de depend√™ncias
        run: dotnet restore Cashflow.sln

      - name: üê≥ Setup Docker para Testcontainers
        run: |
          docker --version
          docker info

      - name: üîå Executar testes de integra√ß√£o
        run: |
          dotnet test tests/Cashflow.IntegrationTests/Cashflow.IntegrationTests.csproj \
            --configuration Release \
            --no-restore \
            --logger "trx;LogFileName=integration-tests.trx" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults
        env:
          TESTCONTAINERS_RYUK_DISABLED: false
          DOCKER_HOST: unix:///var/run/docker.sock

      - name: üìä Upload de resultados de testes
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: ./TestResults
          retention-days: 7

      - name: üìà Publicar relat√≥rio de testes
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Integration Tests Report
          path: ./TestResults/*.trx
          reporter: dotnet-trx
          fail-on-error: true

  # ==========================================
  # üöÄ Testes de Performance (K6)
  # ==========================================
  performance-tests:
    name: Performance Tests (K6)
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: cashflow
          POSTGRES_PASSWORD: cashflow123
          POSTGRES_DB: cashflow_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      rabbitmq:
        image: rabbitmq:3-management-alpine
        env:
          RABBITMQ_DEFAULT_USER: cashflow
          RABBITMQ_DEFAULT_PASS: cashflow123
          RABBITMQ_DEFAULT_VHOST: cashflow
        ports:
          - 5672:5672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: üîß Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: üì• Restore e Build
        run: |
          dotnet restore Cashflow.sln
          dotnet build src/Cashflow.WebApi --configuration Release --no-restore

      - name: üöÄ Iniciar API em background
        run: |
          cd src/Cashflow.WebApi
          nohup dotnet run --configuration Release --no-build > /tmp/api.log 2>&1 &
          echo $! > /tmp/api.pid
        env:
          ASPNETCORE_URLS: http://localhost:5000
          ASPNETCORE_ENVIRONMENT: Development
          ConnectionStrings__PostgreSQL: "Host=localhost;Port=5432;Database=cashflow_db;Username=cashflow;Password=cashflow123"
          ConnectionStrings__Redis: "localhost:6379"
          RabbitMQ__Host: localhost
          RabbitMQ__Port: 5672
          RabbitMQ__Username: cashflow
          RabbitMQ__Password: cashflow123
          RabbitMQ__VirtualHost: cashflow
          Database__ApplyMigrationsOnStartup: "true"

      - name: ‚è≥ Aguardar API ficar pronta
        run: |
          echo "Aguardando API iniciar..."
          for i in {1..30}; do
            if curl -s http://localhost:5000/health > /dev/null 2>&1; then
              echo "‚úÖ API est√° pronta!"
              exit 0
            fi
            echo "Tentativa $i/30..."
            sleep 2
          done
          echo "‚ùå API n√£o iniciou a tempo"
          cat /tmp/api.log
          exit 1

      - name: üîß Setup K6
        uses: grafana/setup-k6-action@v1

      - name: üî• Smoke Test
        run: k6 run tests/k6/smoke-test.js
        env:
          BASE_URL: http://localhost:5000

      - name: üìä Load Test - Consolidado (55 RPS)
        run: k6 run tests/k6/consolidado-load-test.js --out json=k6-results.json
        env:
          BASE_URL: http://localhost:5000
        continue-on-error: true

      - name: üìà Upload K6 Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-performance-results
          path: k6-results.json
          retention-days: 30

      - name: üõë Parar API
        if: always()
        run: |
          if [ -f /tmp/api.pid ]; then
            kill $(cat /tmp/api.pid) || true
          fi

  # ==========================================
  # üê≥ Build de Imagens Docker
  # ==========================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: üê≥ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîë Login no Docker Hub
        uses: docker/login-action@v3
        if: github.event_name == 'push'
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        continue-on-error: true

      - name: üè∑Ô∏è Extrair metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            cashflow/api
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: üê≥ Build da imagem Docker (API)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: cashflow/api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üê≥ Build da imagem Docker (Worker)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.worker
          push: false
          tags: cashflow/worker:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================
  # üìä Cobertura de C√≥digo
  # ==========================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: üì• Download de resultados de testes unit√°rios
        uses: actions/download-artifact@v4
        with:
          name: unit-test-results
          path: ./TestResults/unit

      - name: üì• Download de resultados de testes de integra√ß√£o
        uses: actions/download-artifact@v4
        with:
          name: integration-test-results
          path: ./TestResults/integration
        continue-on-error: true

      - name: üìä Upload para Codecov
        uses: codecov/codecov-action@v4
        with:
          directory: ./TestResults
          fail_ci_if_error: false
          verbose: true
        continue-on-error: true

  # ==========================================
  # ‚úÖ Status Final
  # ==========================================
  status-check:
    name: Status Check
    runs-on: ubuntu-latest
    needs: [build, format, unit-tests, integration-tests]
    if: always()

    steps:
      - name: ‚úÖ Verificar status dos jobs
        run: |
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "‚ùå Build falhou"
            exit 1
          fi
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "‚ùå Testes unit√°rios falharam"
            exit 1
          fi
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "‚ùå Testes de integra√ß√£o falharam"
            exit 1
          fi
          echo "‚úÖ Todos os jobs passaram com sucesso!"

  # ==========================================
  # üè∑Ô∏è Auto Release (apenas na main)
  # ==========================================
  auto-release:
    name: Auto Release
    runs-on: ubuntu-latest
    needs: [build, unit-tests, integration-tests, docker-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üè∑Ô∏è Gerar vers√£o autom√°tica
        id: version
        run: |
          # Pega a √∫ltima tag de vers√£o
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "√öltima tag: $LAST_TAG"
          
          # Extrai major.minor.patch
          VERSION=${LAST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # Incrementa patch por padr√£o
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
          
          # Verifica se os commits desde a √∫ltima tag cont√™m feat: (minor) ou BREAKING CHANGE (major)
          COMMITS=$(git log ${LAST_TAG}..HEAD --oneline 2>/dev/null || git log --oneline)
          
          if echo "$COMMITS" | grep -qE "^[a-f0-9]+ (feat|feature)(\(.+\))?:"; then
            NEW_MINOR=$((MINOR + 1))
            NEW_VERSION="v${MAJOR}.${NEW_MINOR}.0"
          fi
          
          if echo "$COMMITS" | grep -qE "BREAKING CHANGE|^[a-f0-9]+ (feat|fix)(\(.+\))?!:"; then
            NEW_MAJOR=$((MAJOR + 1))
            NEW_VERSION="v${NEW_MAJOR}.0.0"
          fi
          
          echo "Nova vers√£o: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${NEW_VERSION#v}" >> $GITHUB_OUTPUT

      - name: üìù Gerar Release Notes
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --oneline --pretty=format:"- %s" | head -20)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --oneline --pretty=format:"- %s")
          fi
          
          # Categoriza os commits
          FEATURES=$(echo "$COMMITS" | grep -E "^- (feat|feature)" || true)
          FIXES=$(echo "$COMMITS" | grep -E "^- fix" || true)
          OTHERS=$(echo "$COMMITS" | grep -vE "^- (feat|feature|fix)" || true)
          
          {
            echo "## üöÄ O que h√° de novo"
            echo ""
            
            if [ -n "$FEATURES" ]; then
              echo "### ‚ú® Novos recursos"
              echo "$FEATURES"
              echo ""
            fi
            
            if [ -n "$FIXES" ]; then
              echo "### üêõ Corre√ß√µes"
              echo "$FIXES"
              echo ""
            fi
            
            if [ -n "$OTHERS" ]; then
              echo "### üì¶ Outras altera√ß√µes"
              echo "$OTHERS"
              echo ""
            fi
            
            echo "### üìä M√©tricas de Qualidade"
            echo "| Categoria | Quantidade |"
            echo "|-----------|------------|"
            echo "| Testes Unit√°rios (Domain) | 83 |"
            echo "| Testes Unit√°rios (Application) | 120 |"
            echo "| Testes de Integra√ß√£o | 43 |"
            echo "| **Total** | **246** |"
            echo ""
            echo "### üê≥ Imagens Docker"
            echo ""
            echo "\`\`\`bash"
            echo "docker pull ghcr.io/${{ github.repository }}/api:${{ steps.version.outputs.version_number }}"
            echo "docker pull ghcr.io/${{ github.repository }}/worker:${{ steps.version.outputs.version_number }}"
            echo "\`\`\`"
          } > release_notes.md

      - name: üê≥ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîë Login no GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üê≥ Build e Push - API
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/api:${{ steps.version.outputs.version_number }}
            ghcr.io/${{ github.repository }}/api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üê≥ Build e Push - Worker
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.worker
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/worker:${{ steps.version.outputs.version_number }}
            ghcr.io/${{ github.repository }}/worker:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üè∑Ô∏è Criar Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ steps.version.outputs.version }} -m "Release ${{ steps.version.outputs.version }}"
          git push origin ${{ steps.version.outputs.version }}

      - name: üöÄ Criar Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

